flowchart TD
    %% ========================================
    %% MODULE 6 - ENRICHISSEMENT LINGUISTIQUE (PAGEtopage)
    %% CAS G√âN√âRAL : Manuscrits et √âditions
    %% N'UTILISE PAS pour le D√©cret de Gratien
    %% ========================================

    START([üì¶ MODULE 6<br/>PAGEtopage - Enrichissement Linguistique<br/>Cas g√©n√©ral uniquement])

    %% ENTR√âE
    INPUT_MODULE5[üì• XML PAGE finalis√©s<br/>Sortie du Module 5<br/>Manuscrits/√âditions g√©n√©riques]
    START --> INPUT_MODULE5

    %% ========================================
    %% √âTAPE 1 : EXTRACTION
    %% ========================================
    subgraph STEP1 [üìÑ √âTAPE 1 : Extraction]
        EXTRACT_START[üîç Lecture des XML PAGE<br/>Analyse de la structure]

        COLUMN_DECISION{Mode colonnes ?}
        SINGLE_COL[üìÑ Single Column<br/>Extraction s√©quentielle]
        DUAL_COL[üìÑüìÑ Dual Columns<br/>Extraction en 2 colonnes]

        HYPHEN_MERGE[üîó Fusion mots coup√©s<br/>re-/constituer ‚Üí reconstituer]

        JSON_INTERMEDIATE[üíæ Fichier JSON interm√©diaire<br/>extracted.json]

        EXTRACT_START --> COLUMN_DECISION
        COLUMN_DECISION -->|single| SINGLE_COL
        COLUMN_DECISION -->|dual| DUAL_COL
        SINGLE_COL --> HYPHEN_MERGE
        DUAL_COL --> HYPHEN_MERGE
        HYPHEN_MERGE --> JSON_INTERMEDIATE
    end

    INPUT_MODULE5 --> EXTRACT_START

    %% ========================================
    %% √âTAPE 2 : ENRICHISSEMENT
    %% ========================================
    subgraph STEP2 [üéì √âTAPE 2 : Enrichissement]
        ENRICH_START[üìñ Lecture JSON<br/>Chargement corpus]

        SENTENCE_SPLIT[‚úÇÔ∏è D√©coupage en phrases<br/>D√©tection de limites]

        TOKENIZATION[üî§ Tokenisation<br/>S√©paration en mots]

        TREETAGGER_PROCESS[üß† Traitement TreeTagger<br/>Lemmatisation + POS-tagging]

        VERTICAL_FORMAT[üìä Format Vertical<br/>Mot / POS / Lemme]

        CORPUS_VERTICAL[üíæ corpus.vertical.txt<br/>Fichier annot√© complet]

        ENRICH_START --> SENTENCE_SPLIT
        SENTENCE_SPLIT --> TOKENIZATION
        TOKENIZATION --> TREETAGGER_PROCESS
        TREETAGGER_PROCESS --> VERTICAL_FORMAT
        VERTICAL_FORMAT --> CORPUS_VERTICAL
    end

    JSON_INTERMEDIATE --> ENRICH_START

    %% ========================================
    %% √âTAPE 3 : EXPORT
    %% ========================================
    subgraph STEP3 [üì§ √âTAPE 3 : Export]
        EXPORT_START[üìñ Lecture corpus vertical]

        FORMAT_CHOICE{Format de sortie ?}

        FORMAT_CLEAN[‚ú® Clean<br/>Texte brut lisible]
        FORMAT_DIPLO[üìù Diplomatic<br/>Avec annotations inline]
        FORMAT_ANNOT[üìä Annotated<br/>Format tabulaire]

        PAGE_SPLIT[üìë S√©paration par pages<br/>Un fichier par page]

        COMBINED_FILE[üìò Fichier texte complet<br/>texte_complet.txt]

        INDEX_JSON[üóÇÔ∏è Index des pages<br/>pages_index.json]

        STATS_JSON[üìä Statistiques corpus<br/>corpus_stats.json]

        IMAGE_MAPPING[üñºÔ∏è Correspondance images<br/>images_mapping.txt]

        EXPORT_START --> FORMAT_CHOICE
        FORMAT_CHOICE -->|clean| FORMAT_CLEAN
        FORMAT_CHOICE -->|diplomatic| FORMAT_DIPLO
        FORMAT_CHOICE -->|annotated| FORMAT_ANNOT

        FORMAT_CLEAN --> PAGE_SPLIT
        FORMAT_DIPLO --> PAGE_SPLIT
        FORMAT_ANNOT --> PAGE_SPLIT

        PAGE_SPLIT --> COMBINED_FILE
        PAGE_SPLIT --> INDEX_JSON
        PAGE_SPLIT --> STATS_JSON
        PAGE_SPLIT --> IMAGE_MAPPING
    end

    CORPUS_VERTICAL --> EXPORT_START

    %% SORTIE FINALE
    OUTPUT([üì§ SORTIE MODULE 6<br/>Corpus enrichi + Fichiers exploitables])

    CORPUS_VERTICAL --> OUTPUT
    COMBINED_FILE --> OUTPUT
    INDEX_JSON --> OUTPUT
    STATS_JSON --> OUTPUT
    IMAGE_MAPPING --> OUTPUT

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1[üí° Configuration:<br/>config.yaml d√©finit<br/>tous les param√®tres<br/>du traitement]
    note2[üí° TreeTagger:<br/>Premi√®re ex√©cution lente<br/>Installation mod√®les requis<br/>Puis rapide]
    note3[üí° Formats:<br/>Clean = lecture humaine<br/>Diplomatic = semi-annot√©<br/>Annotated = analyse machine]
    note4[üí° Pipeline:<br/>Peut √™tre ex√©cut√© complet<br/>ou √©tape par √©tape<br/>selon les besoins]
    note5[‚ö†Ô∏è IMPORTANT:<br/>Module pour CAS G√âN√âRAL<br/>N'utilise PAS pour D√©cret<br/>D√©cret = pipeline sp√©cifique]

    EXTRACT_START -.-> note1
    TREETAGGER_PROCESS -.-> note2
    FORMAT_CHOICE -.-> note3
    START -.-> note4
    INPUT_MODULE5 -.-> note5

    %% ========================================
    %% STATISTIQUES
    %% ========================================
    subgraph STATS [üìä Caract√©ristiques Techniques]
        S1[Langues support√©es: Latin, Fran√ßais]
        S2[Lemmatiseur: TreeTagger pour langues anciennes]
        S3[Formats sortie: 3 formats configurables]
        S4[D√©pendances: Python 3.10+, TreeTagger, PyYAML]
    end

    %% ========================================
    %% OUTILS
    %% ========================================
    subgraph TOOLS [üõ†Ô∏è Technologies Utilis√©es]
        T1[Python 3.10+: Langage principal]
        T2[TreeTagger: Lemmatisation et POS-tagging]
        T3[PyYAML: Configuration]
        T4[lxml: Manipulation XML]
        T5[JSON: Formats interm√©diaires]
        T6[Argparse: Interface CLI]
    end

    %% ========================================
    %% COMMANDES CLI
    %% ========================================
    subgraph CLI [üíª Commandes Disponibles]
        CMD1[run: Pipeline complet]
        CMD2[extract: √âtape 1 seule]
        CMD3[enrich: √âtape 2 seule]
        CMD4[export: √âtape 3 seule]
        CMD5[init: G√©n√®re config.yaml]
    end

    %% ========================================
    %% FLUX DE DONN√âES
    %% ========================================
    subgraph DATA_FLOW [üîÑ Formats de Donn√©es]
        DF1[Entr√©e: XML PAGE<br/>Format eScriptorium/Transkribus]
        DF2[Interm√©diaire 1: JSON<br/>Texte extrait + m√©tadonn√©es]
        DF3[Interm√©diaire 2: Vertical<br/>Annotations linguistiques]
        DF4[Sortie: TXT + JSON<br/>Formats exploitables]
    end

    %% ========================================
    %% LIEN AVEC MODULE 5
    %% ========================================
    MODULE5_OUTPUT[üì§ MODULE 5<br/>Transcriptions XML finalis√©es<br/>Cas g√©n√©ral: Manuscrits/√âditions<br/>Exclus: D√©cret de Gratien]
    MODULE5_OUTPUT --> INPUT_MODULE5

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef extract fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef enrich fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef export fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef intermediate fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef output fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5
    classDef module5 fill:#b3e5fc,stroke:#01579b,stroke-width:2px

    class START,OUTPUT startEnd
    class COLUMN_DECISION,FORMAT_CHOICE decision
    class EXTRACT_START,SINGLE_COL,DUAL_COL,HYPHEN_MERGE extract
    class ENRICH_START,SENTENCE_SPLIT,TOKENIZATION,TREETAGGER_PROCESS,VERTICAL_FORMAT enrich
    class EXPORT_START,FORMAT_CLEAN,FORMAT_DIPLO,FORMAT_ANNOT,PAGE_SPLIT export
    class JSON_INTERMEDIATE,CORPUS_VERTICAL intermediate
    class COMBINED_FILE,INDEX_JSON,STATS_JSON,IMAGE_MAPPING output
    class note1,note2,note3,note4,note5 note
    class MODULE5_OUTPUT,INPUT_MODULE5 module5

    style STEP1 fill:#e8f5e9,stroke:#1565c0,stroke-width:2px
    style STEP2 fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    style STEP3 fill:#fff8e1,stroke:#e65100,stroke-width:2px
    style STATS fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
    style TOOLS fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 3 3
    style CLI fill:#fce4ec,stroke:#c2185b,stroke-width:2px,stroke-dasharray: 3 3
    style DATA_FLOW fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px,stroke-dasharray: 3 3
