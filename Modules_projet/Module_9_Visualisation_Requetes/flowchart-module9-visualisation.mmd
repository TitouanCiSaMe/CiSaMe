flowchart TD
    %% ========================================
    %% MODULE 9 - VISUALISATION ET GÃ‰NÃ‰RATEUR DE REQUÃŠTES
    %% ========================================

    START([ğŸ“Š MODULE 9<br/>Canon-Law-Toolkit<br/>Analyse du Corpus NoSketch-Engine])

    %% ========================================
    %% DÃ‰CISION PRINCIPALE
    %% ========================================
    DECISION{Quel<br/>module ?}

    START --> DECISION

    %% ========================================
    %% BRANCHE 1 : QUERY GENERATOR
    %% ========================================
    subgraph QUERY_GEN [ğŸ” Query Generator - GÃ©nÃ©rateur de RequÃªtes CQL]
        QG_START[GÃ©nÃ©rateur de<br/>requÃªtes CQL]

        subgraph QG_TYPES [Types de Recherche]
            QG_PROXIMITY[ğŸ“ ProximitÃ©<br/>Recherche mots Ã  distance<br/>configurable 1-20 tokens]
            QG_VARIATIONS["ğŸ”„ Variations<br/>Orthographe mÃ©diÃ©vale:<br/>â€¢ ae/e (caelum â†’ celum)<br/>â€¢ v/u (servus â†’ seruus)<br/>â€¢ j/i (justitia â†’ iustitia)<br/>â€¢ ti/ci (gratia â†’ gracia)<br/>96 variantes possibles"]
            QG_SEMANTIC[ğŸ§  SÃ©mantique<br/>Recherche conceptuelle<br/>avancÃ©e]
            QG_COMBINED["ğŸ“ğŸ”„ ProximitÃ© + Variations<br/>Combinaison des deux approches"]
        end

        QG_CONFIG["âš™ï¸ Configuration:<br/>â€¢ Distance entre mots<br/>â€¢ Types de variations<br/>â€¢ Options lemmatisation"]

        QG_GENERATE[âš¡ GÃ©nÃ©ration requÃªte CQL<br/>PrÃ©visualisation en temps rÃ©el]

        subgraph QG_EXPORT [Export]
            QG_COPY[ğŸ“‹ Copier requÃªte<br/>Coller dans NoSketch]
            QG_DIRECT[ğŸš€ Lancer directement<br/>sur NoSketch Engine]
        end

        QG_START --> QG_PROXIMITY
        QG_START --> QG_VARIATIONS
        QG_START --> QG_SEMANTIC
        QG_START --> QG_COMBINED

        QG_PROXIMITY --> QG_CONFIG
        QG_VARIATIONS --> QG_CONFIG
        QG_SEMANTIC --> QG_CONFIG
        QG_COMBINED --> QG_CONFIG

        QG_CONFIG --> QG_GENERATE
        QG_GENERATE --> QG_COPY
        QG_GENERATE --> QG_DIRECT
    end

    DECISION -->|Query Generator| QG_START

    %% ========================================
    %% BRANCHE 2 : CONCORDANCE ANALYZER - 1 CORPUS
    %% ========================================
    subgraph CONCORD_SINGLE [ğŸ“Š Concordance Analyzer - Analyse Simple]
        subgraph CS_PREPARE [ğŸ”„ PrÃ©paration Export NoSketch]
            CS_SEARCH["ğŸ” Recherche sur NoSketch-Engine<br/>Lancement requÃªte CQL"]

            CS_RESULTS["ğŸ“‹ RÃ©sultats de recherche<br/>Concordances KWIC affichÃ©es"]

            CS_SELECT["âœ… SÃ©lection des rÃ©sultats<br/>RÃ©sultats voulus ou Ã  analyser"]

            CS_METADATA["ğŸ“ Enrichissement mÃ©tadonnÃ©es:<br/>â˜‘ï¸ Cocher ID Ã‰dition (Edi-XX)<br/>â˜‘ï¸ Cocher nÂ° de pages"]

            CS_EXPORT_PREP["ğŸ’¾ Export CSV enrichi:<br/>â€¢ Maximum de contexte<br/>â€¢ Tokens AVANT le KWIC<br/>â€¢ Tokens APRÃˆS le KWIC<br/>â€¢ Export NoSketch normÃ©"]

            CS_SEARCH --> CS_RESULTS
            CS_RESULTS --> CS_SELECT
            CS_SELECT --> CS_METADATA
            CS_METADATA --> CS_EXPORT_PREP
        end

        CS_UPLOAD["ğŸ“¥ Upload fichiers prÃ©parÃ©s:<br/>â€¢ MÃ©tadonnÃ©es CSV (Edi-XX)<br/>â€¢ Export NoSketch Engine normÃ©<br/>avec contexte KWIC Ã©tendu"]

        CS_PERSIST["ğŸ’¾ Persistance automatique:<br/>DonnÃ©es sauvegardÃ©es<br/>Restauration au rechargement"]

        CS_EXPORT_PREP --> CS_UPLOAD

        CS_ENRICH["ğŸ”— Enrichissement automatique:<br/>â€¢ Matching rÃ©fÃ©rences Edi-XX<br/>â€¢ Parsing structure complexe<br/>â€¢ Fallback robuste<br/>â€¢ Taux de correspondance"]

        CS_ANALYZE["ğŸ“ˆ 9 Vues d'analyse spÃ©cialisÃ©es:<br/>â€¢ Vue d'ensemble + stats globales<br/>â€¢ Domaines juridiques<br/>â€¢ Auteurs<br/>â€¢ PÃ©riodes<br/>â€¢ Lieux<br/>â€¢ Timeline interactive<br/>â€¢ Analyse terminologique<br/>â€¢ Nuage de mots KWIC<br/>â€¢ Graphiques (Bar, Temporal, Gantt)"]

        CS_FILTERS["ğŸšï¸ Filtres avancÃ©s:<br/>â€¢ Recherche textuelle<br/>â€¢ Auteur<br/>â€¢ Domaine juridique<br/>â€¢ PÃ©riode<br/>â€¢ Lieu<br/>â€¢ Combinaisons multiples"]

        CS_EXPORT["ğŸ’¾ Export multi-formats:<br/>â€¢ CSV (concordances filtrÃ©es)<br/>â€¢ JSON (analytics complÃ¨tes)<br/>â€¢ PNG (graphiques)"]

        CS_UPLOAD --> CS_PERSIST
        CS_PERSIST --> CS_ENRICH
        CS_ENRICH --> CS_ANALYZE
        CS_ANALYZE --> CS_FILTERS
        CS_FILTERS --> CS_EXPORT
    end

    DECISION -->|Concordance Analyzer<br/>1 corpus| CS_SEARCH

    %% ========================================
    %% BRANCHE 3 : CONCORDANCE ANALYZER - COMPARAISON 2 CORPUS
    %% ========================================
    subgraph CONCORD_COMPARE [ğŸ”€ Concordance Analyzer - Comparaison]
        subgraph CC_PREPARE [ğŸ”„ PrÃ©paration Exports 2 Corpus]
            CC_SEARCH["ğŸ”ğŸ” Recherches sur NoSketch-Engine<br/>Corpus A + Corpus B"]

            CC_RESULTS["ğŸ“‹ RÃ©sultats de recherche<br/>Concordances des 2 corpus"]

            CC_SELECT["âœ… SÃ©lection des rÃ©sultats<br/>Pour chaque corpus"]

            CC_METADATA["ğŸ“ Enrichissement mÃ©tadonnÃ©es:<br/>â˜‘ï¸ Cocher ID Ã‰dition (Edi-XX)<br/>â˜‘ï¸ Cocher nÂ° de pages<br/>Pour corpus A et B"]

            CC_EXPORT_PREP["ğŸ’¾ Exports CSV enrichis:<br/>â€¢ Maximum de contexte KWIC<br/>â€¢ Tokens AVANT/APRÃˆS<br/>â€¢ Exports NoSketch normÃ©s"]

            CC_SEARCH --> CC_RESULTS
            CC_RESULTS --> CC_SELECT
            CC_SELECT --> CC_METADATA
            CC_METADATA --> CC_EXPORT_PREP
        end

        CC_UPLOAD["ğŸ“¥ğŸ“¥ Upload 2 fichiers prÃ©parÃ©s:<br/>â€¢ Corpus A (rÃ©fÃ©rence) + mÃ©tadonnÃ©es<br/>â€¢ Corpus B (comparaison) + mÃ©tadonnÃ©es<br/>Exports NoSketch normÃ©s avec contexte"]

        CC_ENRICH["ğŸ”— Enrichissement des 2 corpus<br/>Matching automatique Edi-XX"]

        CC_EXPORT_PREP --> CC_UPLOAD

        CC_COMPARE["âš–ï¸ Analyse comparative:<br/>â€¢ Volumes (tailles corpus)<br/>â€¢ Auteurs (rÃ©partitions)<br/>â€¢ Domaines juridiques<br/>â€¢ TemporalitÃ© (Ã©volutions)<br/>â€¢ Terminologie (KWIC)<br/>â€¢ Charts comparatifs parallÃ¨les"]

        CC_FILTERS["ğŸšï¸ Filtres indÃ©pendants<br/>pour chaque corpus"]

        CC_EXPORT["ğŸ’¾ Export analyses comparatives:<br/>â€¢ CSV (donnÃ©es comparÃ©es)<br/>â€¢ JSON (analytics complÃ¨tes)<br/>â€¢ PNG (graphiques parallÃ¨les)"]

        CC_UPLOAD --> CC_ENRICH
        CC_ENRICH --> CC_COMPARE
        CC_COMPARE --> CC_FILTERS
        CC_FILTERS --> CC_EXPORT
    end

    DECISION -->|Concordance Analyzer<br/>Comparaison 2 corpus| CC_SEARCH

    %% ========================================
    %% SORTIE
    %% ========================================
    OUTPUT([ğŸ“¤ SORTIE MODULE 9<br/>RequÃªtes CQL + Analyses<br/>Visualisations exportÃ©es])

    QG_COPY --> OUTPUT
    QG_DIRECT --> OUTPUT
    CS_EXPORT --> OUTPUT
    CC_EXPORT --> OUTPUT

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1["ğŸ’¡ CQL:<br/>Corpus Query Language<br/>Langage standard NoSketch<br/>Validation temps rÃ©el"]
    note2["ğŸ’¡ MÃ©tadonnÃ©es Edi-XX:<br/>Identifiants collections<br/>canoniques mÃ©diÃ©vales<br/>PrÃ©-chargement automatique"]
    note3["ğŸ’¡ Interface multilingue:<br/>FranÃ§ais / Anglais<br/>react-i18next<br/>Traductions complÃ¨tes"]
    note4["ğŸ’¡ Visualisations:<br/>Recharts + D3.js<br/>Interactives et exportables<br/>Timeline Gantt"]
    note5["ğŸ’¡ Technologies:<br/>React 18.2, Vite 5.0<br/>CSS Modules<br/>Vitest + React Testing Library"]

    QG_GENERATE -.-> note1
    CS_ENRICH -.-> note2
    CS_ANALYZE -.-> note3
    CS_EXPORT -.-> note4
    START -.-> note5

    %% ========================================
    %% STATISTIQUES
    %% ========================================
    subgraph STATS [ğŸ“Š CaractÃ©ristiques]
        S1[4 types de requÃªtes CQL]
        S2[9 vues d'analyse spÃ©cialisÃ©es]
        S3[Comparaison de 2 corpus]
        S4[3 formats export: CSV, JSON, PNG]
        S5[Persistance automatique donnÃ©es]
        S6[Interface FR/EN]
    end

    %% ========================================
    %% OUTILS
    %% ========================================
    subgraph TOOLS [ğŸ› ï¸ Stack Technique]
        T1[React 18.2 + Vite 5.0]
        T2[Recharts + D3.js]
        T3[react-i18next]
        T4[CSS Modules]
        T5[Vitest + RTL]
        T6[NoSketch Engine API]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:3px
    classDef queryGen fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef queryType fill:#bbdefb,stroke:#1976d2,stroke-width:2px
    classDef config fill:#b2dfdb,stroke:#00796b,stroke-width:2px
    classDef concordSingle fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef concordCompare fill:#ffecb3,stroke:#ff6f00,stroke-width:2px
    classDef prepare fill:#ffe0b2,stroke:#ef6c00,stroke-width:2px
    classDef process fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef export fill:#a5d6a7,stroke:#2e7d32,stroke-width:2px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5

    class START,OUTPUT startEnd
    class DECISION decision
    class QG_START,QG_GENERATE queryGen
    class QG_PROXIMITY,QG_VARIATIONS,QG_SEMANTIC,QG_COMBINED queryType
    class QG_CONFIG,CS_FILTERS,CC_FILTERS config
    class CS_UPLOAD,CS_PERSIST,CS_ENRICH,CS_ANALYZE concordSingle
    class CC_UPLOAD,CC_ENRICH,CC_COMPARE concordCompare
    class CS_SEARCH,CS_RESULTS,CS_SELECT,CS_METADATA,CS_EXPORT_PREP prepare
    class CC_SEARCH,CC_RESULTS,CC_SELECT,CC_METADATA,CC_EXPORT_PREP prepare
    class QG_COPY,QG_DIRECT,CS_EXPORT,CC_EXPORT export
    class note1,note2,note3,note4,note5 note

    style QUERY_GEN fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style QG_TYPES fill:#bbdefb,stroke:#1976d2,stroke-width:2px
    style QG_EXPORT fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    style CONCORD_SINGLE fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    style CS_PREPARE fill:#ffe0b2,stroke:#ef6c00,stroke-width:2px,stroke-dasharray: 3 3
    style CONCORD_COMPARE fill:#ffe0b2,stroke:#ff6f00,stroke-width:2px
    style CC_PREPARE fill:#ffccbc,stroke:#d84315,stroke-width:2px,stroke-dasharray: 3 3
    style STATS fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
    style TOOLS fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 3 3
