flowchart TD
    %% ========================================
    %% MODULE 5 - NETTOYAGE POST-ESCRIPTORIUM
    %% ========================================

    START([üßπ MODULE 5<br/>Nettoyage Post-eScriptorium])

    %% ========================================
    %% IMPORT ET STOCKAGE
    %% ========================================
    IMPORT[üì• Import XML Pages<br/>depuis eScriptorium]
    STOCKAGE[‚òÅÔ∏è Stockage sur Seafile<br/>Format: NOM√âDITION_ID.xml]
    EXPORT[üì§ Export pour<br/>traitement local]

    START --> IMPORT
    IMPORT --> STOCKAGE
    STOCKAGE --> EXPORT

    %% ========================================
    %% D√âCISION LAYOUT
    %% ========================================
    DECISION{Quel type<br/>de layout ?}

    EXPORT --> DECISION

    %% ========================================
    %% BRANCHE SIMPLE PAGE - 1 r√©gion Main
    %% ========================================
    subgraph SIMPLE_FLOW [Simple Page - 1 r√©gion Main]
        SIMPLE_TITLE[Une seule r√©gion Main<br/>par page]
        SIMPLE_OXYGEN[üîß Ouvrir avec Oxyg√®ne<br/>Onglet rechercher]
        SIMPLE_XPATH[üéØ XPath: 1 r√©gion<br/>//TextRegion[contains&#40;@custom, &apos;type:MainZone;&apos;&#41;]//TextLine//Unicode/text]
        SIMPLE_REGEX[‚öôÔ∏è Application Regex<br/>Corrections automatiques]
        SIMPLE_RESULT[‚úÖ Page nettoy√©e]

        SIMPLE_TITLE --> SIMPLE_OXYGEN
        SIMPLE_OXYGEN --> SIMPLE_XPATH
        SIMPLE_XPATH --> SIMPLE_REGEX
        SIMPLE_REGEX --> SIMPLE_RESULT
    end

    %% ========================================
    %% BRANCHE DEUX PAGES - 2 r√©gions Main
    %% ========================================
    subgraph DEUX_FLOW [Deux Pages - 2 r√©gions Main]
        DEUX_TITLE[Deux r√©gions Main<br/>par page<br/>Recto-Verso ou colonnes]
        DEUX_OXYGEN[üîß Ouvrir avec Oxyg√®ne<br/>Onglet rechercher]
        DEUX_XPATH1[üéØ XPath colonne 1<br/>//TextRegion[contains&#40;@custom, &apos;type:MainZone:column#1;&apos;&#41;]//TextLine//Unicode/text]
        DEUX_REGEX1[‚öôÔ∏è Application Regex<br/>sur colonne 1]
        DEUX_XPATH2[üéØ XPath colonne 2<br/>//TextRegion[contains&#40;@custom, &apos;type:MainZone:column#2;&apos;&#41;]//TextLine//Unicode/text]
        DEUX_REGEX2[‚öôÔ∏è Application Regex<br/>sur colonne 2]
        DEUX_RESULT[‚úÖ Page nettoy√©e]

        DEUX_TITLE --> DEUX_OXYGEN
        DEUX_OXYGEN --> DEUX_XPATH1
        DEUX_XPATH1 --> DEUX_REGEX1
        DEUX_REGEX1 --> DEUX_XPATH2
        DEUX_XPATH2 --> DEUX_REGEX2
        DEUX_REGEX2 --> DEUX_RESULT
    end

    %% ========================================
    %% BRANCHE QUATRE PAGES - 4 r√©gions Main
    %% ========================================
    subgraph QUATRE_FLOW [Quatre Pages - 4 r√©gions Main]
        QUATRE_TITLE[Quatre r√©gions Main<br/>par page<br/>Layout complexe]
        QUATRE_OXYGEN[üîß Ouvrir avec Oxyg√®ne<br/>Onglet rechercher]
        QUATRE_XPATH_ALL[üéØ XPath 4 colonnes<br/>column#1, #2, #3, #4<br/>Application s√©quentielle]
        QUATRE_REGEX_ALL[‚öôÔ∏è Application Regex<br/>sur chaque colonne]
        QUATRE_RESULT[‚úÖ Page nettoy√©e]

        QUATRE_TITLE --> QUATRE_OXYGEN
        QUATRE_OXYGEN --> QUATRE_XPATH_ALL
        QUATRE_XPATH_ALL --> QUATRE_REGEX_ALL
        QUATRE_REGEX_ALL --> QUATRE_RESULT
    end

    %% ========================================
    %% CONNEXIONS PRINCIPALES
    %% ========================================
    DECISION -->|1 r√©gion| SIMPLE_TITLE
    DECISION -->|2 r√©gions| DEUX_TITLE
    DECISION -->|4 r√©gions| QUATRE_TITLE

    %% ========================================
    %% V√âRIFICATION ET FINALISATION
    %% ========================================
    VERIFICATION[‚úÖ V√©rification<br/>Contr√¥le pagination<br/>D√©tection erreurs OCR<br/>Coh√©rence globale]
    CORRECTIONS{Erreurs<br/>d√©tect√©es ?}
    CORRECTION_MANUELLE[‚úçÔ∏è Corrections<br/>manuelles<br/>Pages sans lignes d√©tect√©es<br/>Bugs de segmentation]
    VERSION_FINALE[‚ú® Version finale<br/>des transcriptions<br/>au format XML Page]

    SIMPLE_RESULT --> VERIFICATION
    DEUX_RESULT --> VERIFICATION
    QUATRE_RESULT --> VERIFICATION

    VERIFICATION --> CORRECTIONS
    CORRECTIONS -->|Oui| CORRECTION_MANUELLE
    CORRECTIONS -->|Non| VERSION_FINALE
    CORRECTION_MANUELLE --> VERIFICATION

    OUTPUT([üì§ SORTIE MODULE 5<br/>Transcriptions finalis√©es])

    VERSION_FINALE --> OUTPUT

    %% ========================================
    %% D√âTAIL DES REGEX UTILIS√âES
    %% ========================================
    subgraph REGEX_DETAIL [üîß Regex Utilis√©es]
        REGEX_TITLE[üìã Expressions R√©guli√®res]

        subgraph REGEX_COMMUNES [Regex Communes - Espaces et Ponctuation]
            R1[Normalisation espaces<br/>Doubles espaces ‚Üí Simple]
            R2[Correction ponctuation<br/>Espaces avant/apr√®s]
        end

        subgraph REGEX_SPECIFIQUES [Regex Sp√©cifiques au Texte]
            R3[Caract√®res sp√©ciaux:<br/>[!?''`\‚Äì‚Äî‚Ä¶\[\]{}¬´¬ª/\\&*@#¬ß¬∂‚Ä†‚Ä°¬∞^~¬®]<br/>Suppression s√©lective]
            R4[Chiffres: \\d+<br/>D√©tection num√©rotation]
            R5[Folios: T f[¬∞'] [A-Z\\d{1,2}][a-z]{2}<br/>R√©f√©rences manuscrit]
            R6[Folios alt: T f[¬∞'] [A-Z0-9][a-z]{2}<br/>Variante r√©f√©rences]
            R7[Suppressions: \\|[^\\]]*\\]<br/>Contenu entre | et ]]
        end
    end

    %% ========================================
    %% PROC√âDURE OXYG√àNE D√âTAILL√âE
    %% ========================================
    subgraph OXYGEN_PROC [üìö Proc√©dure Oxyg√®ne - TR√àS IMPORTANT]
        OXY_STEP1[1. Ouvrir avec Oxyg√®ne]
        OXY_STEP2[2. Onglet rechercher]
        OXY_STEP3[3. Regex dans texte √† rechercher]
        OXY_STEP4[4. ‚úì Cocher Expression r√©guli√®re]
        OXY_STEP5[5. ‚úì Cocher chemin indiqu√©]
        OXY_STEP6[6. Limiter √† XPath selon layout]
        OXY_STEP7[7. Chercher/Remplacer s√©quentiellement]
    end

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1[üí° Oxyg√®ne:<br/>Outil XML professionnel<br/>Recherche XPath puissante<br/>Regex avanc√©es]
    note2[üí° XPath:<br/>Cible pr√©cis√©ment<br/>les zones MainZone<br/>√âvite zones marginales]
    note3[üí° Regex:<br/>Personnalis√©es selon texte<br/>Ajout/suppression flexible<br/>selon le manuscrit]
    note4[üí° V√©rification:<br/>Pages sans lignes MainZone<br/>Souvent fin de chapitre<br/>Pages non r√©guli√®res]

    SIMPLE_OXYGEN -.-> note1
    SIMPLE_XPATH -.-> note2
    SIMPLE_REGEX -.-> note3
    VERIFICATION -.-> note4

    %% ========================================
    %% STATISTIQUES
    %% ========================================
    subgraph STATS [üìä Statistiques Indicatives]
        S1[Temps nettoyage: ~20 min par ≈ìuvre]
        S2[Pages probl√©matiques: Fins de chapitres]
        S3[Cause bugs: Mauvaise segmentation MainZone]
    end

    %% ========================================
    %% OUTILS
    %% ========================================
    subgraph TOOLS [üõ†Ô∏è Outils Utilis√©s]
        T1[Oxyg√®ne XML Editor]
        T2[Expressions r√©guli√®res Regex]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef import fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef stockage fill:#bbdefb,stroke:#1976d2,stroke-width:2px
    classDef simple fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef deux fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef quatre fill:#ffccbc,stroke:#d84315,stroke-width:2px
    classDef regex fill:#e1bee7,stroke:#8e24aa,stroke-width:2px
    classDef verification fill:#b2dfdb,stroke:#00796b,stroke-width:2px
    classDef finale fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5
    classDef title fill:#e0e0e0,stroke:#757575,stroke-width:2px
    classDef oxygen fill:#e1f5fe,stroke:#01579b,stroke-width:2px

    class START,OUTPUT startEnd
    class DECISION,CORRECTIONS decision
    class IMPORT,EXPORT import
    class STOCKAGE stockage
    class SIMPLE_TITLE,SIMPLE_OXYGEN,SIMPLE_XPATH,SIMPLE_REGEX,SIMPLE_RESULT simple
    class DEUX_TITLE,DEUX_OXYGEN,DEUX_XPATH1,DEUX_REGEX1,DEUX_XPATH2,DEUX_REGEX2,DEUX_RESULT deux
    class QUATRE_TITLE,QUATRE_OXYGEN,QUATRE_XPATH_ALL,QUATRE_REGEX_ALL,QUATRE_RESULT quatre
    class R1,R2,R3,R4,R5,R6,R7 regex
    class VERIFICATION,CORRECTION_MANUELLE verification
    class VERSION_FINALE finale
    class note1,note2,note3,note4 note
    class REGEX_TITLE title
    class OXY_STEP1,OXY_STEP2,OXY_STEP3,OXY_STEP4,OXY_STEP5,OXY_STEP6,OXY_STEP7 oxygen

    style SIMPLE_FLOW fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style DEUX_FLOW fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    style QUATRE_FLOW fill:#fbe9e7,stroke:#d84315,stroke-width:2px
    style REGEX_DETAIL fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px,stroke-dasharray: 5 5
    style REGEX_COMMUNES fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style REGEX_SPECIFIQUES fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style STATS fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
    style TOOLS fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 3 3
    style OXYGEN_PROC fill:#e1f5fe,stroke:#01579b,stroke-width:3px
